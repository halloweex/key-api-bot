<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KoreanStory Sales Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
    <header>
        <div class="header-top">
            <h1>KoreanStory Sales Dashboard</h1>
            {% if user %}
            <div class="user-info">
                <span class="user-name">{{ user.first_name }}{% if user.username %} (@{{ user.username }}){% endif %}</span>
                <a href="/logout" class="logout-btn">Logout</a>
            </div>
            {% endif %}
        </div>
        <div class="date-controls">
            <div class="period-buttons">
                <button class="period-btn" data-period="today">Today</button>
                <button class="period-btn" data-period="yesterday">Yesterday</button>
                <button class="period-btn active" data-period="week">This Week</button>
                <button class="period-btn" data-period="last_week">Last Week</button>
                <button class="period-btn" data-period="month">This Month</button>
                <button class="period-btn" data-period="last_month">Last Month</button>
            </div>
            <div class="category-filter">
                <select id="sourceFilter">
                    <option value="">All Sources</option>
                    <option value="1">Instagram</option>
                    <option value="2">Telegram</option>
                    <option value="4">Shopify</option>
                </select>
                <select id="parentCategoryFilter">
                    <option value="">All Categories</option>
                </select>
                <select id="categoryFilter" disabled>
                    <option value="">All Subcategories</option>
                </select>
                <select id="brandFilter">
                    <option value="">All Brands</option>
                </select>
            </div>
            <div class="custom-dates">
                <input type="date" id="startDate" />
                <span>to</span>
                <input type="date" id="endDate" />
                <button id="applyDates">Apply</button>
            </div>
        </div>
    </header>

    <main>
        <section class="summary-cards">
            <div class="card">
                <div class="card-icon orders-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Total Orders</span>
                    <span class="card-value" id="totalOrders">-</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon revenue-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Total Revenue</span>
                    <span class="card-value" id="totalRevenue">-</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon avg-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Average Check</span>
                    <span class="card-value" id="avgCheck">-</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon returns-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Returns</span>
                    <span class="card-value" id="totalReturns">-</span>
                </div>
            </div>
        </section>

        <!-- Milestone Progress -->
        <section class="milestone-section" id="milestoneSection">
            <div class="milestone-container">
                <div class="milestone-header">
                    <span class="milestone-label">Progress to <span id="milestoneTarget">-</span></span>
                    <span class="milestone-percentage" id="milestonePercentage">0%</span>
                </div>
                <div class="milestone-track">
                    <div class="milestone-fill" id="milestoneFill"></div>
                    <div class="milestone-markers" id="milestoneMarkers"></div>
                </div>
                <div class="milestone-values">
                    <span class="milestone-current" id="milestoneCurrent">₴0</span>
                    <span class="milestone-goal" id="milestoneGoal">₴0</span>
                </div>
            </div>
        </section>

        <section class="charts-grid">
            <div class="chart-container full-width">
                <h3>Revenue Trend</h3>
                <canvas id="revenueChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Orders by Source</h3>
                <canvas id="ordersChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Revenue by Source</h3>
                <canvas id="revenueBySourceChart"></canvas>
            </div>
        </section>

        <!-- Customer Insights Section -->
        <section class="section-divider">
            <h2>Customer Insights</h2>
        </section>

        <section class="summary-cards customer-cards">
            <div class="card">
                <div class="card-icon customers-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Total Customers</span>
                    <span class="card-value" id="totalCustomers">-</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon repeat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Repeat Rate</span>
                    <span class="card-value" id="repeatRate">-</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon aov-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Average Order Value</span>
                    <span class="card-value" id="avgOrderValue">-</span>
                </div>
            </div>
        </section>

        <section class="charts-grid">
            <div class="chart-container">
                <h3>
                    New vs Returning Customers
                    <button class="info-btn" id="customersInfoBtn" aria-label="How is this calculated?">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </button>
                </h3>
                <div class="info-tooltip" id="customersInfoTooltip">
                    <div class="info-tooltip-content">
                        <button class="info-tooltip-close" aria-label="Close">&times;</button>
                        <h4>How is this calculated?</h4>
                        <p><strong>New Customers:</strong> Customers whose account was created during the selected period.</p>
                        <p><strong>Returning Customers:</strong> Customers whose account existed before the selected period started.</p>
                        <p><strong>Repeat Rate:</strong> Percentage of orders from returning customers (customers who registered before the selected period started).</p>
                    </div>
                </div>
                <canvas id="customersChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>
                    AOV Trend
                    <button class="info-btn" id="aovInfoBtn" aria-label="How is this calculated?">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
                    </button>
                </h3>
                <div class="info-tooltip" id="aovInfoTooltip">
                    <div class="info-tooltip-content">
                        <button class="info-tooltip-close" aria-label="Close">&times;</button>
                        <h4>How is AOV calculated?</h4>
                        <p><strong>AOV (Average Order Value):</strong> Total Revenue ÷ Number of Orders for each day.</p>
                        <p><strong>Revenue:</strong> Sum of product prices × quantities (products_total field).</p>
                        <p><strong>Excluded:</strong> Orders with return/cancel statuses are not counted.</p>
                    </div>
                </div>
                <canvas id="aovTrendChart"></canvas>
            </div>
        </section>

        <!-- Product Performance Section -->
        <section class="section-divider">
            <h2>Product Performance</h2>
        </section>

        <section class="charts-grid">
            <div class="chart-container">
                <h3>Top 10 Products (by Quantity)</h3>
                <canvas id="topProductsChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Top 10 Products (by Revenue)</h3>
                <canvas id="topRevenueChart"></canvas>
            </div>
            <div class="chart-container full-width">
                <h3>Sales by Category</h3>
                <canvas id="categoryChart"></canvas>
            </div>
        </section>

        <!-- Brand Analytics Section -->
        <section class="section-divider">
            <h2>Brand Analytics</h2>
        </section>

        <section class="summary-cards brand-cards">
            <div class="card">
                <div class="card-icon brand-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Total Brands</span>
                    <span class="card-value" id="totalBrands">-</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon top-brand-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Top Brand</span>
                    <span class="card-value" id="topBrandName">-</span>
                </div>
            </div>
            <div class="card">
                <div class="card-icon share-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                </div>
                <div class="card-content">
                    <span class="card-label">Top Brand Share</span>
                    <span class="card-value" id="topBrandShare">-</span>
                </div>
            </div>
        </section>

        <section class="charts-grid">
            <div class="chart-container">
                <h3>Top 10 Brands (by Revenue)</h3>
                <canvas id="brandRevenueChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>Top 10 Brands (by Quantity)</h3>
                <canvas id="brandQuantityChart"></canvas>
            </div>
        </section>
    </main>

    <footer>
        <p>KoreanStory Sales Dashboard v{{ version }}</p>
    </footer>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <script src="/static/js/charts.js"></script>
</body>
</html>
