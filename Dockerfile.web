# ─── Stage 1: Build React Frontend ─────────────────────────────────────────────
FROM node:20-alpine AS frontend-builder

WORKDIR /app/web/frontend

# Install dependencies first (better layer caching)
COPY web/frontend/package.json web/frontend/package-lock.json ./
RUN npm ci

# Copy all frontend source files
COPY web/frontend/ ./

# Build the app (outputs to ../static-v2 per vite.config.ts)
RUN npm run build

# Verify build output exists
RUN ls -la /app/web/static-v2/

# ─── Stage 2: Python Runtime ───────────────────────────────────────────────────
FROM python:3.14-slim

WORKDIR /app

# Install system dependencies (libgomp required by LightGBM)
RUN apt-get update && apt-get install -y --no-install-recommends libgomp1 && rm -rf /var/lib/apt/lists/*

# Install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy bot modules (needed for shared services)
COPY bot/ ./bot/

# Copy core modules (models, exceptions, etc.)
COPY core/ ./core/

# Copy web application (excluding frontend source)
COPY web/__init__.py web/config.py web/main.py web/schemas.py web/middleware.py ./web/
COPY web/routes/ ./web/routes/
COPY web/services/ ./web/services/
COPY web/static/ ./web/static/
COPY web/templates/ ./web/templates/

# Copy built React app from frontend stage
COPY --from=frontend-builder /app/web/static-v2 ./web/static-v2

# Create data directory for shared SQLite database
RUN mkdir -p /app/data

VOLUME ["/app/data"]

# Expose port
EXPOSE 8080

# Run FastAPI with uvicorn
CMD ["uvicorn", "web.main:app", "--host", "0.0.0.0", "--port", "8080"]
